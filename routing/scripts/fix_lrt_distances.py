#!/usr/bin/env python3
"""
Script to fix LRT-1 shape_dist_traveled values in stop_times.txt
"""

import math
from typing import List, Tuple

def haversine_distance(lat1: float, lon1: float, lat2: float, lon2: float) -> float:
    """Calculate haversine distance between two points in kilometers"""
    R = 6371  # Earth's radius in kilometers
    
    lat1, lon1, lat2, lon2 = map(math.radians, [lat1, lon1, lat2, lon2])
    dlat = lat2 - lat1
    dlon = lon2 - lon1
    
    a = math.sin(dlat/2)**2 + math.cos(lat1) * math.cos(lat2) * math.sin(dlon/2)**2
    c = 2 * math.asin(math.sqrt(a))
    return R * c

def find_closest_shape_point(stop_lat: float, stop_lon: float, shape_points: List[Tuple[float, float, float]]) -> int:
    """Find the closest shape point to a stop"""
    min_distance = float('inf')
    closest_index = 0
    
    for i, (lat, lon, _) in enumerate(shape_points):
        dist = haversine_distance(stop_lat, stop_lon, lat, lon)
        if dist < min_distance:
            min_distance = dist
            closest_index = i
    
    return closest_index

def calculate_cumulative_distance(shape_points: List[Tuple[float, float, float]]) -> List[float]:
    """Calculate cumulative distance along shape points"""
    cumulative_distances = [0.0]
    total_distance = 0.0
    
    for i in range(1, len(shape_points)):
        lat1, lon1, _ = shape_points[i-1]
        lat2, lon2, _ = shape_points[i]
        segment_distance = haversine_distance(lat1, lon1, lat2, lon2)
        total_distance += segment_distance
        cumulative_distances.append(total_distance)
    
    return cumulative_distances

def main():
    # LRT-1 stops with their coordinates
    lrt_stops = [
        ("stop_95_001", 14.63618010993791, 120.98236647648679, "R. Papa Station"),
        ("stop_95_002", 14.63055401964111, 120.98146341906227, "Abad Santos Station"),
        ("stop_95_003", 14.622648295791706, 120.98286837431158, "Blumentritt Station"),
        ("stop_95_004", 14.616697509874896, 120.98274457407899, "Tayuman Station"),
        ("stop_95_005", 14.611028962321754, 120.98243542646685, "Bambang Station"),
        ("stop_95_006", 14.610955410332409, 120.98246543530905, "United Nations Station"),
        ("stop_95_007", 14.605174899042723, 120.98200536260282, "Doroteo Jose Station"),
        ("stop_95_008", 14.599065929357508, 120.98130789105932, "Carriedo Station"),
        ("stop_95_009", 14.592799397030575, 120.9815980881886, "Central Terminal Station"),
        ("stop_95_010", 14.582486739260261, 120.98462385570332, "Pedro Gil Station"),
        ("stop_95_011", 14.576546555031157, 120.98805463795571, "Quirino Station"),
        ("stop_95_012", 14.563655727275673, 120.99462522812325, "Vito Cruz Station"),
    ]
    
    # Shape points from shapes.txt (shape_095)
    shape_points = [
        (14.636212630466332, 120.98238721364197, 0.0),
        (14.63598091151292, 120.98227686188291, None),
        (14.63574919250756, 120.98216651035693, None),
        (14.63551747345023, 120.98205615906409, None),
        (14.63528575434094, 120.98194580800431, None),
        (14.63505403517971, 120.98183545717760, None),
        (14.63482231596650, 120.98172510658398, None),
        (14.63459059670135, 120.98161475622344, None),
        (14.63435887738424, 120.98150440609599, None),
        (14.63412715801518, 120.98139405620159, None),
        (14.633663719121188, 120.98117335711197, 0.0028231891046881915),
        (14.63343582611195, 120.98107334865767, None),
        (14.63320793306004, 120.98097334041107, None),
        (14.63298003996546, 120.98087333237221, None),
        (14.632524253648299, 120.9806733169176, 0.004067545066577341),
        (14.632144430278842, 120.9806733169176, 0.004447368436034086),
        (14.631619911211288, 120.98075743588964, 0.004978589909324314),
        (14.631013999694076, 120.9810471790172, 0.005650214690474011),
        (14.630548260599667, 120.98149114026137, 0.006293654268358688),
        (14.63036093024689, 120.98166939306260, None),
        (14.63017359975858, 120.98184764555955, None),
        (14.62998626913474, 120.98202589775224, None),
        (14.62979893837538, 120.98220414964064, None),
        (14.62961160748049, 120.98238240122480, None),
        (14.629236945284148, 120.98273890348031, 0.008103753963750588),
        (14.628753115169758, 120.98298658690612, 0.008647296656658032),
        (14.628111021391405, 120.98306603260289, 0.009294286640301515),
        (14.62784198739586, 120.98305716982718, None),
        (14.62757295339999, 120.98304830707319, None),
        (14.62730391940377, 120.98303944434093, None),
        (14.62703488540722, 120.98303058163037, None),
        (14.62676585141035, 120.98302171894156, None),
        (14.62649681741313, 120.98301285627446, None),
        (14.62622778341557, 120.98300399362907, None),
        (14.62595874941769, 120.98299513100541, None),
        (14.62568971541947, 120.98298626840348, None),
        (14.62542068142091, 120.98297740582325, None),
        (14.62515164742202, 120.98296854326476, None),
        (14.62488261342279, 120.98295968072799, None),
        (14.62461357942323, 120.98295081821293, None),
        (14.62434454542333, 120.98294195571957, None),
        (14.62407551142310, 120.98293309324794, None),
        (14.62380647742253, 120.98292423079803, None),
        (14.62353744342164, 120.98291536836985, None),
        (14.62326840942040, 120.98290650596334, None),
        (14.622730341416926, 120.98288878121554, 0.014677885347679338),
        (14.62246154858413, 120.98288135504262, None),
        (14.62219275575110, 120.98287392888788, None),
        (14.62192396291783, 120.98286650275134, None),
        (14.62165517008433, 120.98285907663296, None),
        (14.62138637725060, 120.98285165053278, None),
        (14.62111758441663, 120.98284422445073, None),
        (14.62084879158243, 120.98283679838691, None),
        (14.62057999874798, 120.98282937234123, None),
        (14.62031120591331, 120.98282194631373, None),
        (14.62004241307840, 120.98281452030442, None),
        (14.61977362024325, 120.98280709431327, None),
        (14.61950482740787, 120.98279966834032, None),
        (14.61923603457226, 120.98279224238551, None),
        (14.61896724173641, 120.98278481644890, None),
        (14.61869844890032, 120.98277739053046, None),
        (14.61842965606400, 120.98276996463019, None),
        (14.61816086322744, 120.98276253874809, None),
        (14.61789207039065, 120.98275511288415, None),
        (14.61762327755363, 120.98274768703841, None),
        (14.61735448471637, 120.98274026121082, None),
        (14.61681689904114, 120.98272540961017, 0.02059358403956475),
        (14.61655046774244, 120.98271359229558, None),
        (14.61628403644315, 120.98270177500966, None),
        (14.61601760514327, 120.98268995775240, None),
        (14.61575117384279, 120.98267814052379, None),
        (14.61548474254172, 120.98266632332383, None),
        (14.61521831124005, 120.98265450615254, None),
        (14.61495187993778, 120.98264268900992, None),
        (14.61468544863492, 120.98263087189594, None),
        (14.61441901733147, 120.98261905481063, None),
        (14.61415258602742, 120.98260723775398, None),
        (14.61388615472278, 120.98259542072597, None),
        (14.61361972341754, 120.98258360372662, None),
        (14.61335329211169, 120.98257178675591, None),
        (14.61308686080527, 120.98255996981389, None),
        (14.61282042949824, 120.98254815290052, None),
        (14.61255399819063, 120.98253633601577, None),
        (14.61228756688241, 120.98252451915968, None),
        (14.61202113557360, 120.98251270233226, None),
        (14.61175470426419, 120.98250088553348, None),
        (14.61148827295420, 120.98248906876337, None),
        (14.610955410332409, 120.98246543530905, 0.02646083522899143),
        (14.61069223024321, 120.98244552525243, None),
        (14.61042905015233, 120.98242561524344, None),
        (14.61016587005976, 120.98240570528215, None),
        (14.60990268996551, 120.98238579536856, None),
        (14.60963950986955, 120.98236588550263, None),
        (14.60937632977192, 120.98234597568438, None),
        (14.60911314967259, 120.98232606591378, None),
        (14.60884996957158, 120.98230615619087, None),
        (14.60858678946888, 120.98228624651564, None),
        (14.60832360936448, 120.98226633688807, None),
        (14.60806042925840, 120.98224642730818, None),
        (14.60779724915064, 120.98222651777598, None),
        (14.60753406904118, 120.98220660829143, None),
        (14.60727088893003, 120.98218669885455, None),
        (14.60700770881720, 120.98216678946534, None),
        (14.60674452870268, 120.98214688012379, None),
        (14.60648134858647, 120.98212697082991, None),
        (14.60621816846857, 120.98210706158370, None),
        (14.60595498834898, 120.98208715238515, None),
        (14.60569180822771, 120.98206724323423, None),
        (14.605165447980099, 120.98202742507544, 0.03226734166624883),
        (14.60490595445279, 120.98201091831605, None),
        (14.60464646092432, 120.98199441159561, None),
        (14.60438696739469, 120.98197790491416, None),
        (14.60412747386390, 120.98196139827162, None),
        (14.60386798033196, 120.98194489166808, None),
        (14.60360848679885, 120.98192838510349, None),
        (14.60334899326458, 120.98191187857783, None),
        (14.60308949972915, 120.98189537209115, None),
        (14.60283000619256, 120.98187886564342, None),
        (14.602311019115902, 120.98184585286481, 0.035127539667862466),
        (14.60205621242801, 120.98180918893149, None),
        (14.60180140573440, 120.98177252508313, None),
        (14.60154659903506, 120.98173586131972, None),
        (14.60129179233000, 120.98169919764125, None),
        (14.60103698561921, 120.98166253404776, None),
        (14.60078217890270, 120.98162587053919, None),
        (14.60052737218047, 120.98158920711559, None),
        (14.60027256545252, 120.98155254377693, None),
        (14.60001775871884, 120.98151588052319, None),
        (14.59976295197944, 120.98147921735443, None),
        (14.59950814523432, 120.98144255427057, None),
        (14.598998531726906, 120.98136922835772, 0.03847414147014094),
        (14.59875871904866, 120.98129597017504, None),
        (14.59851890634756, 120.98122271215210, None),
        (14.59827909362362, 120.98114945428887, None),
        (14.59803928087682, 120.98107619658536, None),
        (14.59779946810719, 120.98100293904157, None),
        (14.597319842499388, 120.98085642443311, 0.04022940936641121),
        (14.59709621059442, 120.98083042660691, None),
        (14.59687257868656, 120.98080442883358, None),
        (14.59664894677583, 120.98077843111307, None),
        (14.59642531486223, 120.98075243344543, None),
        (14.595978051026378, 120.98070043826868, 0.04158023727570808),
        (14.59572999273994, 120.98077076206933, None),
        (14.59548193443245, 120.98084108571142, None),
        (14.59523387610392, 120.98091140919495, None),
        (14.59498581775433, 120.98098173251992, None),
        (14.59473775938370, 120.98105205568633, None),
        (14.59448970099202, 120.98112237869421, None),
        (14.59424164257930, 120.98119270154351, None),
        (14.59399358414553, 120.98126302423429, None),
        (14.59374552569071, 120.98133334676650, None),
        (14.59349746721484, 120.98140366914019, None),
        (14.59324940871794, 120.98147399135533, None),
        (14.592753291660983, 120.98161463531005, 0.044932076948954416),
        (14.59251678346044, 120.98167945735385, None),
        (14.59228027524202, 120.98174427925834, None),
        (14.59204376700571, 120.98180910102349, None),
        (14.591570750479463, 120.98193874413585, 0.0461582295401723),
        (14.59133313532069, 120.98194741008049, None),
        (14.59109552016159, 120.98195607600643, None),
        (14.59085790500218, 120.98196474191366, None),
        (14.59062028984245, 120.98197340780214, None),
        (14.59014505952203, 120.98199073952304, 0.04758486832640916),
        (14.58988843357893, 120.98202193690139, None),
        (14.58963180763168, 120.98205313420699, None),
        (14.58937518168030, 120.98208433143985, None),
        (14.588861929765102, 120.98214672568736, 0.04887744469033183),
        (14.58859691578212, 120.98211726149243, None),
        (14.58833190179545, 120.98208779736845, None),
        (14.58806688780508, 120.98205833331539, None),
        (14.58753685981327, 120.98199940542213, 0.050210678967492366),
        (14.58731127141649, 120.98210453447408, None),
        (14.58708568297269, 120.98220966331057, None),
        (14.58686009448188, 120.98231479193164, None),
        (14.58663450594405, 120.98241992033729, None),
        (14.58640891735921, 120.98252504852752, None),
        (14.58618332872736, 120.98263017650231, None),
        (14.58595774004849, 120.98273530426167, None),
        (14.58573215132262, 120.98284043180560, None),
        (14.58550656254973, 120.98294555913415, None),
        (14.58505538486294, 120.983155813145, 0.05294837813844492),
        (14.58483532678124, 120.98328018371937, None),
        (14.58461526863375, 120.98340455404518, None),
        (14.58439521042047, 120.98352892412241, None),
        (14.58417515214139, 120.98365329395106, None),
        (14.58395509379653, 120.98377766353114, None),
        (14.58373503538589, 120.98390203286267, None),
        (14.58351497690946, 120.98402640194564, None),
        (14.58329491836724, 120.98415077078005, None),
        (14.58307485975925, 120.98427513936592, None),
        (14.58285480108547, 120.98439950770324, None),
        (14.582414683540577, 120.98464824363225, 0.055981635831618075),
        (14.58218013476575, 120.98478429318044, None),
        (14.58194558591220, 120.98492034243887, None),
        (14.58171103697994, 120.98505639140753, None),
        (14.58147648796897, 120.98519244008644, None),
        (14.58124193887929, 120.98532848847555, None),
        (14.58100738971090, 120.98546453657492, None),
        (14.58077284046381, 120.98560058438457, None),
        (14.58053829113801, 120.98573663190446, None),
        (14.58030374173351, 120.98587267913463, None),
        (14.58006919225031, 120.98600872607506, None),
        (14.57983464268840, 120.98614477272577, None),
        (14.57960009304779, 120.98628081908674, None),
        (14.57936554332850, 120.98641686515801, None),
        (14.57913099353050, 120.98655291093958, None),
        (14.57889644365380, 120.98668895643144, None),
        (14.57866189369842, 120.98682500163358, None),
        (14.57842734366434, 120.98696104654607, None),
        (14.57819279355157, 120.98709709116885, None),
        (14.57795824336012, 120.98723313550194, None),
        (14.57772369308998, 120.98736917954537, None),
        (14.57748914274115, 120.98750522329912, None),
        (14.57725459231363, 120.98764126676322, None),
        (14.57702004180744, 120.98777730993764, None),
        (14.576550940559002, 120.98804939541753, 0.06276037577503686),
        (14.57631915828800, 120.98817882283774, None),
        (14.57608737594578, 120.98830824998565, None),
        (14.57585559353234, 120.98843767686128, None),
        (14.57562381104771, 120.98856710346460, None),
        (14.57539202849186, 120.98869652979562, None),
        (14.57516024586481, 120.98882595585438, None),
        (14.57492846316655, 120.98895538164086, None),
        (14.57469668039708, 120.98908480715505, None),
        (14.57446489755642, 120.98921423239698, None),
        (14.57423311464455, 120.98934365736666, None),
        (14.57400133166149, 120.98947308206407, None),
        (14.57376954860723, 120.98960250648922, None),
        (14.57353776548177, 120.98973193064214, None),
        (14.57330598228511, 120.98986135452280, None),
        (14.57307419901726, 120.98999077813124, None),
        (14.57284241567822, 120.99012020146745, None),
        (14.57261063226799, 120.99024962453143, None),
        (14.57237884878656, 120.99037904732317, None),
        (14.57214706523395, 120.99050846984268, None),
        (14.57191528161015, 120.99063789209002, None),
        (14.57168349791516, 120.99076731406512, None),
        (14.57145171414898, 120.99089673576803, None),
        (14.57121993031163, 120.99102615719873, None),
        (14.57098814640309, 120.99115557835725, None),
        (14.57075636242337, 120.99128499924359, None),
        (14.570292794250392, 120.99154384019971, 0.06992804900668323),
        (14.57005246482130, 120.99165626642160, None),
        (14.56981213533851, 120.99176869239834, None),
        (14.56957180580199, 120.99188111812994, None),
        (14.56933147621178, 120.99199354361642, None),
        (14.56909114656785, 120.99210596885773, None),
        (14.56885081687022, 120.99221839385393, None),
        (14.56861048711888, 120.99233081860501, None),
        (14.56837015731384, 120.99244324311098, None),
        (14.56812982745509, 120.99255566737185, None),
        (14.56788949754264, 120.99266809138759, None),
        (14.56764916757649, 120.99278051515822, None),
        (14.56740883755664, 120.99289293868377, None),
        (14.56716850748309, 120.99300536196419, None),
        (14.56692817735584, 120.99311778499955, None),
        (14.56668784717489, 120.99323020778984, None),
        (14.56644751694025, 120.99334263033501, None),
        (14.56620718665191, 120.99345505263513, None),
        (14.56596685630988, 120.99356747469017, None),
        (14.56572652591415, 120.99367989650015, None),
        (14.56548619546474, 120.99379231806508, None),
        (14.56524586496162, 120.99390473938492, None),
        (14.56500553440482, 120.99401716045973, None),
        (14.56476520379433, 120.99412958128950, None),
        (14.56452487313016, 120.99424200187420, None),
        (14.56428454241229, 120.99435442221390, None),
        (14.56404421164074, 120.99446684230854, None),
        (14.563563549936589, 120.99469168176273, 0.07735715632457331),
    ]
    
    # Calculate cumulative distances along the shape
    cumulative_distances = calculate_cumulative_distance(shape_points)
    
    print("=== LRT-1 Corrected shape_dist_traveled Values ===\n")
    print("OUTBOUND (R. Papa → Vito Cruz):")
    print("trip_id,arrival_time,departure_time,stop_id,stop_sequence,shape_dist_traveled")
    
    # Calculate distances for outbound trip
    for i, (stop_id, stop_lat, stop_lon, stop_name) in enumerate(lrt_stops):
        closest_index = find_closest_shape_point(stop_lat, stop_lon, shape_points)
        distance = cumulative_distances[closest_index]
        
        # Format time (every 5 minutes starting from 06:00)
        minutes = i * 5
        hours = minutes // 60
        mins = minutes % 60
        time_str = f"06:{hours:02d}:{mins:02d}"
        
        print(f"route_095_outbound,{time_str}:00,{time_str}:00,{stop_id},{i+1},{distance:.6f}")
    
    print("\nINBOUND (Vito Cruz → R. Papa):")
    print("trip_id,arrival_time,departure_time,stop_id,stop_sequence,shape_dist_traveled")
    
    # Calculate distances for inbound trip (reverse order)
    for i, (stop_id, stop_lat, stop_lon, stop_name) in enumerate(reversed(lrt_stops)):
        closest_index = find_closest_shape_point(stop_lat, stop_lon, shape_points)
        distance = cumulative_distances[closest_index]
        
        # Format time (every 5 minutes starting from 06:00)
        minutes = i * 5
        hours = minutes // 60
        mins = minutes % 60
        time_str = f"06:{hours:02d}:{mins:02d}"
        
        print(f"route_095_inbound,{time_str}:00,{time_str}:00,{stop_id},{i+1},{distance:.6f}")
    
    print("\n=== Summary ===")
    print(f"Total LRT-1 route length: {cumulative_distances[-1]:.3f} km")
    print("Copy the above lines and replace the corresponding lines in your stop_times.txt file")

if __name__ == "__main__":
    main() 